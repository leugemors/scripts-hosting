#############################################################################
##
##  include file for wordpress configuration
##
#############################################################################


# ---------------------------------------------------------------------------
#  support clean (aka search engine friendly) urls
# ---------------------------------------------------------------------------

location / { 
  try_files $uri $uri/ /index.php?$args;

  # ddos protection settings
  limit_req zone=one;
  limit_conn two 10;
}


# ---------------------------------------------------------------------------
# deny running scripts inside writable directories
# ---------------------------------------------------------------------------

location ~* /(images|cache|media|logs|tmp)/.*\.(php|pl|py|jsp|asp|sh|cgi)$ {
  return 403;
  error_page 403 /403_error.html;
}


# ---------------------------------------------------------------------------
#  setup for php
# ---------------------------------------------------------------------------

location ~ \.php(/|$) {
  fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  include /etc/nginx/fastcgi.conf;
}


# ---------------------------------------------------------------------------
#  hide the php version
# ---------------------------------------------------------------------------

fastcgi_hide_header X-Powered-By;
proxy_hide_header X-Powered-By;


# ---------------------------------------------------------------------------
# caching of files
# ---------------------------------------------------------------------------

location ~* \.(ico|pdf|flv)$ {
  expires 1y; 
}

location ~* \.(js|css|png|jpg|jpeg|gif|swf|xml|txt)$ {
  expires 14d;
}


# ---------------------------------------------------------------------------
#  deny access to xmlrpc.php (can also be done with a plugin)
# ---------------------------------------------------------------------------

location = /xmlrpc.php {
  deny all;
  access_log off;
  log_not_found off;
}


# ---------------------------------------------------------------------------
#  deny access to wp-cron.php
# ---------------------------------------------------------------------------

location = /wp-cron.php {
  deny all;
  access_log off;
  log_not_found off;
}


# ---------------------------------------------------------------------------
#  deny access to .user.ini (wordfence)
# ---------------------------------------------------------------------------

location ~ ^/\.user\.ini {
  deny all;
  access_log off;
  log_not_found off;
}


# ---------------------------------------------------------------------------
#  disable direct access to any php files
# ---------------------------------------------------------------------------

location ~* /(?:uploads|files|wp-content|wp-includes|akismet)/.*.php$ {
  deny all;
  access_log off;
  log_not_found off;
}


# ---------------------------------------------------------------------------
#  security headers (cross site scripting)
# ---------------------------------------------------------------------------

add_header X-Frame-Options "SAMEORIGIN";
add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";
add_header X-Content-Type-Options "nosniff";
add_header X-XSS-Protection "1; mode=block";
#add_header Content-Security-Policy "default-src 'none'; font-src 'self' data: https://fonts.gstatic.com; img-src 'self' data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/";


# ---------------------------------------------------------------------------
#  settings added because ddos attacks
# ---------------------------------------------------------------------------

client_body_timeout 5s;
client_header_timeout 5s;
client_body_buffer_size 16k;        # some documentation is recommending 1k only
client_header_buffer_size 2k;       # some documentation is recommending 1k only
client_max_body_size 16k;           # some documentation is recommending 1k only
large_client_header_buffers 3 1k;   # we could decrease this to 2 buffers of 1k


# ---------------------------------------------------------------------------
#  disable directory listing
# ---------------------------------------------------------------------------

autoindex off;


# ---------------------------------------------------------------------------
#  allow well-known as per rfc5785
# ---------------------------------------------------------------------------

location ~* ^/.well-known/ {
  allow all;
}


### EOF #####################################################################
